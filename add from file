#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <time.h>
#include <stdbool.h>
#include <float.h>
#define MAX_ITER 100
#define EPS 1e-6

// Ham doc du lieu tu file
void input(const char *filename, double point[100][10], int *n, int *K, int *Dim) {
    FILE *file = fopen(filename, "r");
    if (file == NULL) {
        printf("Khong the mo file %s\n ", filename);
        exit(1);
    }

    // Doc so cum (K), so chieu (Dim), so diem (n) tu file
    fscanf(file, "%d %d %d", K, Dim, n);

    // Doc toa do cac diem
    for (int i = 0; i < *n; i++) {
        for (int j = 0; j < *Dim; j++) {
            fscanf(file, "%lf", &point[i][j]);
        }
    }

    fclose(file);
}


// Ham tinh khoang cach Euclidean
double euclidean_distance(double *a, double *b, int Dim) {
    double distance = 0.0;
    for (int i = 0; i < Dim; i++) {
        distance += pow(a[i] - b[i], 2);
    }
    return sqrt(distance);
}

// Ham khoi tao cac tam cum tu cac diem da nhap
void initialize_centroids(double centroids[50][10], double point[100][10], int n, int K, int Dim) {
    srand(time(NULL));
    int first_index = rand() % n;
    for (int j = 0; j < Dim; j++) {
            centroids[0][j] = point[first_index][j];
        }
    for (int c = 1; c < K; c++){
    	double max_dist = -1.0;
    	int next_index = -1;
    	for (int i = 0;i < n; i++){
    		double min_dist = DBL_MAX;
    		for (int j = 0; j<c; j++){
    			double dist = euclidean_distance(point[i], centroids[j], Dim);
    			if (dist < min_dist)
    			    min_dist = dist;
			}
		    if (min_dist > max_dist){
			    max_dist = min_dist;
			    next_index = i;
		    }
        }
        for (int j = 0; j < Dim; j++){
        	centroids[c][j] = point[next_index][j];
		}
	}
}

// Ham tim cum gan nhat cho mot diem
int find_nearest_cluster(double *point, double centroids[50][10], int K, int Dim) {
    int cluster = 0;
    double min_distance = euclidean_distance(point, centroids[0], Dim);
    printf("d[0] = %.2lf\n ",min_distance);
    for (int i = 1; i < K; i++) {
        double distance = euclidean_distance(point, centroids[i], Dim);
        printf("d[%d] = %.2lf\n ", i, distance);
        if (distance < min_distance) {
            min_distance = distance;
            cluster = i;
        }
    }
    printf("min_dis = d[%d]", cluster);
    return cluster;
}
// Ham kiem tra xem cac centroids co thay doi không
bool centroids_changed(double old_centroids[50][10], double new_centroids[50][10], int K, int Dim) {
    for (int i = 0; i < K; i++) {
        if (euclidean_distance(old_centroids[i], new_centroids[i], Dim) > EPS) {
            return true; //chua hoi tu
        }
    }
    return false; //da hoi tu
}

// Ham sao chep centroids
void copy_centroids(double dest[50][10], double src[50][10], int K, int Dim) {
    for (int i = 0; i < K; i++) {
        for (int j = 0; j < Dim; j++) {
            dest[i][j] = src[i][j];
        }
    }
}

// Ham cap nhat tam cum
void update_centroids(double centroids[50][10], double point[100][10], int labels[100], int K, int n, int Dim) {
    int count[50] = {0};
    double sum[50][10] = {0};
    
    // Tinh tong va so luong diem trong tung cum
    for (int i = 0; i < n; i++) {
        int cluster = labels[i];
        count[cluster]++;
        for (int j = 0; j < Dim; j++) {
            sum[cluster][j] += point[i][j];
        }
    }
    
    // Cap nhat tam cum moi
    for (int i = 0; i < K; i++) {
        if (count[i] > 0) {
            for (int j = 0; j < Dim; j++) {
                centroids[i][j] = sum[i][j]/count[i];
            }
        }
    }
}

void output(const char *filename, double point[100][10], int labels[100], int n, int Dim){
    FILE *file = fopen(filename, "w");
    if(file == NULL){
        printf("khong the ghi du lieu tu file %s\n ",filename);
        exit(1);
    }
    for(int i=0; i<Dim; i++){
    fprintf(file, "x%d  ",i+1);
}

    fprintf(file,"cluster\n ");
    for(int i=0;i<n;i++){
        for(int j=0;j<Dim;j++){
            fprintf(file, "%.2f ",point[i][j]);
        }
        fprintf(file, "%d\n ", labels[i]);
    }
    fclose(file);
    printf("\nghi file thanh cong");
}

int main() {
    double point[100][10];  // Mang luu diem du lieu
    double centroids[50][10]; // Mang luu tam cum
    double old_centroids[50][10]; // Mang luu tam cum cu de so sanh
    int labels[100];         // Mang luu nhan cum cua tung diem
    int n, K, Dim;          // So diem, so cum, so chieu
    bool converged = false;  // Bien kiem tra dieu kien dung
    int iter_count = 0;  // Bien đem so vong lap

    // Buoc 1: Nhap du lieu tu file
    input("D:/csdl1.txt", point, &n, &K, &Dim);

    // Buoc 2: Khoi tao tam cum ngau nhien
    initialize_centroids(centroids, point, n, K, Dim);
    printf("\n --- Cac tam cum ban dau ---\n ");
    for (int i = 0; i < K; i++) {
        printf("Cluster %d: (", i);
        for (int j = 0; j < Dim; j++) {
            printf("%.2f", centroids[i][j]);
            if (j < Dim - 1) printf(", ");
        }
        printf(")\n ");
    }

    // Buoc 3: Thuat toan K-means
    for (int iter = 0; iter < MAX_ITER && !converged; iter++) {
        iter_count++;
        printf("\n --- Vong lap %d ---\n ", iter_count);
        
        // Luu centroids cu de so sanh
        copy_centroids(old_centroids, centroids, K, Dim);
        printf("Nhan cum: \n\n");
        // Gan nhan cum cho tung diem
        for (int i = 0; i < n; i++) {
            labels[i] = find_nearest_cluster(point[i], centroids, K, Dim);
            printf("\nDiem %d -> Cum %d\n\n", i + 1, labels[i]);
        }
        
        // Cap nhat tam cum
        update_centroids(centroids, point, labels, K, n, Dim);
        printf("\nCac tam cum: \n");
        for (int i = 0; i < K; i++) {
            printf("Cum %d: (", i);
            for (int j = 0; j < Dim; j++) {
                printf("%.2f", centroids[i][j]);
                if (j < Dim - 1) printf(", ");
            }
            printf(")\n");
        }
        
        // Kiem tra dieu kien dung (centroids khong thay doi dang ke)
        converged = !centroids_changed(old_centroids, centroids, K, Dim);
        
    }
    
    // Buoc 4: xuat ket qua file
    output("D:/ocsdl1.txt", point, labels, n, Dim);
    return 0;
}
